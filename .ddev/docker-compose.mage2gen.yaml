version: '3.6'

services:
  # Main Django Application
  mage2gen:
    container_name: ddev-${DDEV_SITENAME}-mage2gen
    build:
      context: ..
      dockerfile: Dockerfile
    # Ensure user permissions match the host for file editing
    user: "$DDEV_UID:$DDEV_GID"
    labels:
      com.ddev.site-name: ${DDEV_SITENAME}
      com.ddev.approot: $DDEV_APPROOT
    environment:
      # Route standard DDEV URL to port 8000
      - VIRTUAL_HOST=$DDEV_HOSTNAME
      - VIRTUAL_PORT=8000
      # Also expose ports directly
      - HTTP_EXPOSE=8000:8000
      - HTTPS_EXPOSE=8001:8000
      - DJANGO_SETTINGS_MODULE=settings
    volumes:
      # Mount project root to /usr/app/src as expected by run_app.sh
      - "../:/usr/app/src"
    depends_on:
      - postgres
    # Override command to ensure we use the mounted volume's script if needed, 
    # or the built-in one. The built-in /run_app.sh expects /usr/app/src to exist.
    command: /run_app.sh

  # Required PostgreSQL Database
  # (Mage2Gen settings/base.py hardcodes the postgresql_psycopg2 backend)
  postgres:
    container_name: ddev-${DDEV_SITENAME}-postgres
    image: postgres:13
    environment:
      - POSTGRES_USER=mage2gen
      - POSTGRES_PASSWORD=mage2gen
      - POSTGRES_DB=mage2gen
    labels:
      com.ddev.site-name: ${DDEV_SITENAME}
      com.ddev.approot: $DDEV_APPROOT
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432"

volumes:
  postgres_data: